<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>H·ªá th·ªëng Ch·∫•m Thi Vovinam</title>

<style>
body{
    margin:0;
    font-family:Segoe UI;
    background:#f4f6f9;
}

header{
    background:#0d6efd;
    color:white;
    padding:15px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.container{
    padding:20px;
}

.card{
    background:white;
    padding:25px;
    border-radius:10px;
    box-shadow:0 4px 15px rgba(0,0,0,0.08);
}

input.score-low {
    color: red;
    font-weight: bold;
    background: #fff5f5;
}

button{
    padding:8px 15px;
    border:none;
    border-radius:6px;
    cursor:pointer;
}

.btn-primary{background:#0d6efd;color:white;}
.btn-danger{background:#dc3545;color:white;}
.btn-success{background:#198754;color:white;}
.btn-warning{background:#ffc107;color:black;}

.tabs button{
    margin-right:10px;
    background:#e9ecef;
}

.tab-content{
    display:none;
    margin-top:20px;
}

.tab-active{
    display:block;
}

input, select{
    padding:6px;
    margin:5px 0 15px 0;
    width:100%;
}

table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
}

table th, table td{
    border:1px solid #ddd;
    padding:6px;
    text-align:center;
}

.login-box{
    width:350px;
    margin:120px auto;   /* cƒÉn gi·ªØa ngang */
    text-align:center;
}

.login-box a:hover{
    text-decoration:underline;
}

.success{color:green;font-weight:bold;}

.table-wrapper{
    height: 500px;   /* gi·∫£m xu·ªëng th·∫•p */
    overflow-y: auto;
}

#scoreTable thead th{
    position: sticky;
    top: 0;
    background: #0d6efd;
    color: white;
    z-index: 3;
}
</style>
</head>

<body>

<!-- ================= LOGIN ================= -->
<div id="loginPage" class="login-box card">
    <h2>H·ªÜ TH·ªêNG CH·∫§M THI VOVINAM</h2>

    <label>Ch·ªçn Gi√°m kh·∫£o</label>
    <select id="loginJudge">
        <option value="">-- Ch·ªçn --</option>
        <option>Admin</option>
        <option>Nguy·ªÖn Tr∆∞·ªùng ƒê·ªãnh</option>
        <option>B√πi Tu·∫•n ƒê·∫°t</option>
        <option>V≈© ƒê√¨nh ƒê·ªìng</option>
        <option>Nguy·ªÖn H·ªØu D≈©ng</option>
        <option>H·ªì Quang H√≤a</option>
        <option>Tr·∫ßn VƒÉn Hi·∫øn</option>
        <option>Ho√†ng Vi·ªát H√πng</option>
        <option>Ki·ªÅu VƒÉn H√πng</option>        
        <option>B√πi ƒê·ª©c Thao</option>
        <option>ƒê·∫∑ng Th·ªã Th·∫£o</option>
        <option>Tr·ªãnh Th·ªã Thu Th·∫£o</option>
        <option>L√™ Nh·∫≠t Long</option>
        <option>Ho√†ng Duy Nam</option>
        <option>Nguy·ªÖn Danh Ph√∫</option>
        <option>Nghi√™m Xu√¢n Quang</option>
        <option>Ph·∫°m Minh T·∫•n</option>
        <option>Tr·∫ßn Cao Tr·ªçng</option>
        <option>Nguy·ªÖn Vi·∫øt Vƒ©nh</option>
    </select>
    <label>M·∫≠t kh·∫©u</label>
    <input type="password" id="loginPassword" placeholder="123456">

    <button class="btn-primary" onclick="login()">ƒêƒÇNG NH·∫¨P</button>

    <div style="margin-top:15px;">
        <a href="#" onclick="resetPassword()">Qu√™n m·∫≠t kh·∫©u?</a>
    </div>
</div>
<!-- ================= DASHBOARD ================= -->
<div id="dashboard" style="display:none;">

<header>
    <div>
        <strong>H·ªÜ TH·ªêNG CH·∫§M THI VOVINAM</strong><br>
        giamthiwellspring.site
    </div>
    <div>
        <span id="judgeName"></span>
        <button class="btn-danger" onclick="logout()">ƒêƒÉng xu·∫•t</button>
    </div>
</header>

<div class="container">

    <div class="tabs">
        <button onclick="openTab('setup')">Thi·∫øt l·∫≠p</button>
        <button onclick="openTab('score')">Phi·∫øu ƒëi·ªÉm</button>
        <button onclick="openTab('history')">L·ªãch s·ª≠</button>
        <button onclick="openTab('print')">PHI·∫æU ƒêI·ªÇM IN</button>
    </div>

    <!-- TAB 1 -->
    <div id="setup" class="tab-content tab-active card">
        <h3>Ch·ªçn kh√≥a thi</h3>

        <label>Ch·ªçn kh√≥a thi</label>
        <select id="examSelect">
        </select>
        <button class="btn-primary" onclick="confirmExam()">X√ÅC NH·∫¨N</button>
        <hr style="margin:16px 0;">
        <h3>Ch·∫ø ƒë·ªô Offline (khi server t·∫Øt)</h3>

        <input type="file" id="offlineFile" accept="application/json">
        <button class="btn-warning" onclick="importOfflineJson()">N·∫°p d·ªØ li·ªáu Offline</button>

        <div id="offlineInfo" style="margin-top:10px; opacity:.8;"></div>
        <div id="welcomeBox" class="success"></div>
    </div>

    <!-- TAB 2 -->
    <div id="score" class="tab-content card">
        <h3>Phi·∫øu ƒëi·ªÉm</h3>

        <label>Ch·ªçn c·∫•p ƒëai</label>
        <select id="beltSelect">
            <option>Lam ƒëai I</option>
            <option>Lam ƒëai II</option>
            <option>Lam ƒëai III</option>
        </select>

        <div class="table-wrapper">
        <table id="scoreTable">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>H·ªç t√™n</th>
                    <th>NƒÉm sinh</th>
                    <th>ƒê∆°n v·ªã</th>
                    <th>L√Ω thuy·∫øt</th>
                    <th>ƒê√≤n cƒÉn b·∫£n</th>
                    <th>Chi·∫øn l∆∞·ª£c</th>
                    <th>Kh√≥a g·ª°</th>
                    <th>Giao ƒë·∫•u</th>
                    <th>V√µ l·ª±c</th>
                    <th>T·ªïng ƒëi·ªÉm</th>
                    <th>H·∫°ng</th>
                    <th>K·∫øt qu·∫£</th>                 
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        </div>

        <h4>X√°c nh·∫≠n & K√Ω t√™n</h4>

        <!-- üî• BOX TR·∫†NG TH√ÅI CH·ªÆ K√ù -->
        <div id="signatureStatusBox"
            style="
                border-radius:8px;
                padding:12px;
                margin-bottom:15px;
                font-size:14px;
                background:#f8f9fa;
            ">
        </div>

        <label>H·ªç t√™n Gi√°m kh·∫£o</label>
        <input type="text" id="signatureName" placeholder="Nh·∫≠p h·ªç t√™n k√Ω x√°c nh·∫≠n">

        <label>Ch·ªçn ch·∫ø ƒë·ªô k√Ω</label>
        <select id="signatureMode" onchange="switchSignatureMode()">
            <option value="draw">V·∫Ω tr·ª±c ti·∫øp</option>
            <option value="upload">T·∫£i ·∫£nh ch·ªØ k√Ω</option>
        </select>

        <!-- V·∫º -->
        <div id="drawArea">
            <canvas id="signatureCanvas" width="400" height="150"
                style="border:1px solid #ccc; background:white;"></canvas>
            <br>
            <button type="button" class="btn-warning" onclick="clearCanvas()">X√≥a</button>
        </div>

        <!-- UPLOAD -->
        <div id="uploadArea" style="display:none;">
            <input type="file" id="signatureUpload" accept="image/*">
            <div id="previewBox"></div>
        </div>

        <br>
        <button class="btn-success" onclick="submitScore()">G·ª≠i ƒëi·ªÉm</button>
    </div>

    <!-- TAB 3 -->
    <div id="history" class="tab-content card">
    <h3>L·ªãch s·ª≠ g·ª≠i ƒëi·ªÉm</h3>

    <div style="display:flex; gap:10px; align-items:center; margin:10px 0;">
        <button class="btn-primary" onclick="renderHistory()">T·∫£i l·∫°i</button>
        <button class="btn-success" onclick="manualSync()">Sync ngay</button>
        <button class="btn-warning" onclick="clearHistory()">X√≥a l·ªãch s·ª≠ m√°y n√†y</button>
        <span id="historyStatus" style="opacity:.7;"></span>
    </div>

    <div class="table-wrapper" style="height:420px;">
        <table id="historyTable">
        <thead>
        <tr>
            <th>Th·ªùi gian g·ª≠i</th>
            <th>Phi·∫øu ƒëi·ªÉm c·∫•p ƒëai ƒë√£ ch·∫•m</th>
            <th>Tr·∫°ng th√°i g·ª≠i</th>
            <th>X√≥a</th>
        </tr>
        </thead>
        <tbody id="historyBody"></tbody>
        </table>
    </div>
    </div>
     <!-- TAB 4 -->   
    <div id="print" class="tab-content card">
    <h3>PHI·∫æU ƒêI·ªÇM IN</h3>

    <div style="display:flex; gap:10px; align-items:center; margin:10px 0;">
        <button class="btn-primary" onclick="loadPrintPdf()">T·∫£i phi·∫øu ƒëi·ªÉm</button>
        <a id="pdfOpenLink" target="_blank" style="text-decoration:none;"></a>
        <span id="printHint" style="opacity:.7;"></span>
    </div>

    <iframe
        id="pdfFrame"
        style="width:100%; height:75vh; border:1px solid #ddd; border-radius:8px; background:white;"
    ></iframe>
    </div>
</div>

<script>

// =============================
// API BASE CHU·∫®N PRODUCTION
// =============================

let API_BASE;

if (location.protocol === "file:") {
    API_BASE = "http://127.0.0.1:5001/api";
} else {
    // d√πng domain server ch√≠nh
    API_BASE = "https://chamthivovinam.giamthiwellspring.site/api";
}
let examConfirmed = false;
let OFFLINE_DATA = null;

function offlineKey() {
  return "OFFLINE_EXPORTED_DATA::v1";
}

async function manualSync(){

    if(isOfflineMode()){
        alert("ƒêang ·ªü ch·∫ø ƒë·ªô OFFLINE.\nH√£y ƒëƒÉng nh·∫≠p l·∫°i ONLINE ƒë·ªÉ sync.");
        return;
    }

    if (!offlineDB) {
        alert("Offline DB ch∆∞a s·∫µn s√†ng");
        return;
    }

    getAllQueue(async (items) => {

        if(items.length === 0){
            alert("Kh√¥ng c√≥ d·ªØ li·ªáu c·∫ßn sync.");
            return;
        }

        for (let item of items) {

            try {
                await sendBatch(item.data);

                removeFromQueue(item.id);

                updateHistory(item.id, { status: "SENT" });

            } catch (err) {
                console.log("Sync th·∫•t b·∫°i:", item.id);
            }
        }

        renderHistory();
        alert("Sync ho√†n t·∫•t.");
    });
}

async function loadSignatureStatus(){

    const exam = document.getElementById("examSelect").value;
    const belt = document.getElementById("beltSelect").value;

    if(!exam || !belt) return;

    try{
        const res = await fetch(
            `${API_BASE}/signature_status?exam=${encodeURIComponent(exam)}&belt=${encodeURIComponent(belt)}`
        );

        if(!res.ok) return;

        const data = await res.json();

        const judges = data.judges_signed || [];
        const chief = data.chief_signed;

        const box = document.getElementById("signatureStatusBox");

        let statusHTML = "";
        let bgColor = "#f8f9fa";
        let borderColor = "#ccc";

        // ===============================
        // TR·∫†NG TH√ÅI LOGIC
        // ===============================

        if(judges.length > 0 && chief){
            // üü¢ Ho√†n t·∫•t
            bgColor = "#e6f4ea";
            borderColor = "#28a745";
            statusHTML = `
                <b>üü¢ ƒê√É HO√ÄN T·∫§T K√ù X√ÅC NH·∫¨N</b><br>
                Gi√°m kh·∫£o: ${judges.join(", ")}<br>
                Ch√°nh ch·ªß kh·∫£o: ${chief}
            `;
        }
        else if(judges.length > 0 && !chief){
            // üü° Ch·ªù CCK
            bgColor = "#fff3cd";
            borderColor = "#ffc107";
            statusHTML = `
                <b>üü° ƒêANG CH·ªú CH√ÅNH CH·ª¶ KH·∫¢O K√ù</b><br>
                Gi√°m kh·∫£o ƒë√£ k√Ω: ${judges.join(", ")}
            `;
        }
        else if(judges.length === 0 && chief){
            // üîµ CCK k√Ω m·ªôt m√¨nh
            bgColor = "#e7f1ff";
            borderColor = "#0d6efd";
            statusHTML = `
                <b>üîµ CCK ƒê√É K√ù (CH·∫§M TR·ª∞C TI·∫æP)</b><br>
                Ch√°nh ch·ªß kh·∫£o: ${chief}
            `;
        }
        else{
            // üî¥ Ch∆∞a ai k√Ω
            bgColor = "#fdecea";
            borderColor = "#dc3545";
            statusHTML = `
                <b>üî¥ CH∆ØA C√ì CH·ªÆ K√ù X√ÅC NH·∫¨N</b>
            `;
        }

        box.style.background = bgColor;
        box.style.borderLeft = `5px solid ${borderColor}`;
        box.innerHTML = statusHTML;

    }catch(e){
        console.log("Kh√¥ng load ƒë∆∞·ª£c tr·∫°ng th√°i k√Ω");
    }
}


function updateNetworkStatus(){
    const el = document.getElementById("netStatus");

    if(isOfflineMode()){
        el.innerHTML = "üî¥ OFFLINE MODE";
        el.style.color = "yellow";
    } else {
        el.innerHTML = "üü¢ ONLINE";
        el.style.color = "lightgreen";
    }
}

window.addEventListener("load", updateNetworkStatus);

function saveOfflineData(data){
  OFFLINE_DATA = data;
  localStorage.setItem(offlineKey(), JSON.stringify(data));
  document.getElementById("offlineInfo").innerHTML =
    `‚úÖ ƒê√£ n·∫°p Offline: <b>${data.exam}</b> (${data.belts?.length || 0} c·∫•p ƒëai)`;
}

function loadOfflineDataFromStorage(){
  try{
    const raw = localStorage.getItem(offlineKey());
    if(!raw) return null;
    OFFLINE_DATA = JSON.parse(raw);
    return OFFLINE_DATA;
  }catch{
    return null;
  }
}

function importOfflineJson(){
  const f = document.getElementById("offlineFile").files[0];
  if(!f){
    alert("Ch·ªçn file JSON export tr∆∞·ªõc!");
    return;
  }
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const data = JSON.parse(reader.result);

      // validate t·ªëi thi·ªÉu
      if(!data.exam || !data.belts || !data.candidates){
        alert("File JSON kh√¥ng ƒë√∫ng format!");
        return;
      }

      saveOfflineData(data);

      // ƒë·ªï danh s√°ch examSelect lu√¥n theo offline
      const examSelect = document.getElementById("examSelect");
      examSelect.innerHTML = `<option value="${data.exam}">${data.exam}</option>`;
      examSelect.value = data.exam;

      // ƒë·ªï belts
      const beltSelect = document.getElementById("beltSelect");
      beltSelect.innerHTML = "";
      data.belts.forEach(b => beltSelect.innerHTML += `<option value="${b}">${b}</option>`);

      alert("‚úÖ N·∫°p d·ªØ li·ªáu offline xong. B·∫°n c√≥ th·ªÉ X√ÅC NH·∫¨N v√† ch·∫•m.");
    }catch(e){
      alert("JSON l·ªói: " + e.message);
    }
  };
  reader.readAsText(f, "utf-8");
}
// ===============================
// OFFLINE QUEUE (IndexedDB)
// ===============================

let offlineDB;

const dbRequest = indexedDB.open("vovinam_offline_db", 1);

dbRequest.onupgradeneeded = function (event) {
    offlineDB = event.target.result;
    offlineDB.createObjectStore("score_queue", { keyPath: "id" });
};

dbRequest.onsuccess = function (event) {
    offlineDB = event.target.result;
};

function saveToQueue(payload) {

    if (!offlineDB) {
        console.log("Offline DB ch∆∞a s·∫µn s√†ng");
        return;
    }

    const tx = offlineDB.transaction("score_queue", "readwrite");
    const store = tx.objectStore("score_queue");

    store.put({
        id: payload.batch_id,
        data: payload,
        created_at: Date.now()
    });
}

function removeFromQueue(id) {

    if (!offlineDB) return;

    const tx = offlineDB.transaction("score_queue", "readwrite");
    tx.objectStore("score_queue").delete(id);
}

function getAllQueue(callback) {
    const tx = offlineDB.transaction("score_queue", "readonly");
    const store = tx.objectStore("score_queue");

    const req = store.getAll();
    req.onsuccess = function () {
        callback(req.result);
    };
}
// ===================
// LOAD KH√ìA THI
// ===================
function loadExams(){

  if(isOfflineMode()){
      const data = loadOfflineDataFromStorage();
      if(!data){
          alert("Ch∆∞a c√≥ d·ªØ li·ªáu Offline");
          return;
      }

      const select = document.getElementById("examSelect");
      select.innerHTML = `<option value="${data.exam}">${data.exam}</option>`;
      select.value = data.exam;

      loadBelts();
      return;
  }

  fetch(API_BASE + "/exams")
    .then(res => res.json())
    .then(data => {
      const select = document.getElementById("examSelect");
      select.innerHTML = "";
      data.forEach(exam=> select.innerHTML += `<option value="${exam}">${exam}</option>`);
      loadBelts();
    })
    .catch(err => {
      alert("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server!");
      console.log(err);
    });
}

// ===================
// LOAD C·∫§P ƒêAI
// ===================
function loadBelts(){
  const exam = document.getElementById("examSelect").value;

  if(isOfflineMode()){
    const data = loadOfflineDataFromStorage();
    const select = document.getElementById("beltSelect");
    select.innerHTML = "";
    data.belts.forEach(b => select.innerHTML += `<option value="${b}">${b}</option>`);
    loadExamHeaders();
    loadCandidates();
    loadSignatureStatus();
    return;
  }

  fetch(API_BASE + "/belts?exam=" + encodeURIComponent(exam))
    .then(res => res.json())
    .then(data => {
      const select = document.getElementById("beltSelect");
      select.innerHTML = "";
      data.forEach(belt=> select.innerHTML += `<option value="${belt}">${belt}</option>`);
      loadExamHeaders();
      loadCandidates();
      loadSignatureStatus();
    });
}

// ===================
// LOAD TH√ç SINH
// ===================
function loadExamHeaders(){
  const belt = document.getElementById("beltSelect").value;

  if(isOfflineMode()){
    const data = loadOfflineDataFromStorage();
    const contents = data.contents_by_belt?.[belt] || ["L√Ω thuy·∫øt","ƒê√≤n cƒÉn b·∫£n","Chi·∫øn l∆∞·ª£c","Kh√≥a g·ª°","Giao ƒë·∫•u","V√µ l·ª±c"];
    const headers = document.querySelectorAll("#scoreTable thead th");
    for(let i=0; i<6; i++){
      headers[i+4].innerText = contents[i] || "";
    }
    return;
  }

  fetch(`${API_BASE}/exam_contents?belt=${encodeURIComponent(belt)}`)
    .then(res => res.json())
    .then(contents => {
      const headers = document.querySelectorAll("#scoreTable thead th");
      for(let i=0; i<6; i++){
        headers[i+4].innerText = contents[i];
      }
    });
}

async function submitScore(){

    const name = document.getElementById("signatureName").value.trim();
    const mode = document.getElementById("signatureMode").value;

    if(!name){
        alert("Vui l√≤ng nh·∫≠p h·ªç t√™n k√Ω x√°c nh·∫≠n");
        return;
    }

    let signatureData = null;

    if(mode === "draw"){
        signatureData = canvas.toDataURL();

        const blank = document.createElement("canvas");
        blank.width = canvas.width;
        blank.height = canvas.height;

        if(signatureData === blank.toDataURL()){
            alert("Vui l√≤ng k√Ω t√™n tr∆∞·ªõc khi g·ª≠i ƒëi·ªÉm");
            return;
        }
    }
    else{
        if(!uploadedSignature){
            alert("Vui l√≤ng t·∫£i ·∫£nh ch·ªØ k√Ω");
            return;
        }
        signatureData = uploadedSignature;
    }

    const exam = document.getElementById("examSelect").value;
    const belt = document.getElementById("beltSelect").value;
    const rows = document.querySelectorAll("#scoreTable tbody tr");

    if(!exam){
        alert("Ch∆∞a ch·ªçn kh√≥a thi");
        return;
    }

    // ============================
    // üî• T·∫†O BATCH PAYLOAD
    // ============================

    // M·ªöI ‚Äì th√™m ƒëo·∫°n c·∫£nh b√°o TR∆Ø·ªöC d√≤ng batchId
    // üî• Ki·ªÉm tra ƒëi·ªÉm th·∫•p tr∆∞·ªõc khi g·ª≠i
    const lowScoreWarnings = [];

    document.querySelectorAll("#scoreTable tbody tr").forEach(row => {
        const name = row.cells[1].textContent.trim();
        const inputs = row.querySelectorAll("input");
        const lowFields = [];

        inputs.forEach((inp, idx) => {
            const val = parseFloat(inp.value);
            if (!isNaN(val) && val <= 4.5) {
                const header = document.querySelectorAll("#scoreTable thead th")[idx + 4].textContent;
                lowFields.push(`${header}: ${val}`);
            }
        });

        if (lowFields.length > 0) {
            lowScoreWarnings.push(`‚Ä¢ ${name}: ${lowFields.join(", ")}`);
        }
    });

    if (lowScoreWarnings.length > 0) {
        const proceed = confirm(
            "‚ö†Ô∏è C·∫¢NH B√ÅO: C√≥ th√≠ sinh ƒëi·ªÉm th·∫•p (‚â§ 4.5):\n\n" +
            lowScoreWarnings.join("\n") +
            "\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën g·ª≠i ƒëi·ªÉm kh√¥ng?"
        );
        if (!proceed) return;
    }

    const batchId = crypto.randomUUID
    ? crypto.randomUUID()
    : Date.now() + "_" + Math.random();
    const rowsData = [];

    rows.forEach(row => {

        const candidate_id = row.getAttribute("data-id");
        const inputs = row.querySelectorAll("input");

        const scores = Array.from(inputs).map(i => {
            let raw = i.value.trim().replace(",", ".");
            const val = parseFloat(raw);
            return isNaN(val) ? 0 : val;
        });

        rowsData.push({
            client_txn_id: crypto.randomUUID(),
            candidate_id,
            scores
        });
    });

    const payload = {
        batch_id: batchId,
        exam,
        belt,
        signature_name: name,
        signature_image: signatureData,
        rows: rowsData
    };

    const historyId = batchId;

    addHistory({
        id: historyId,
        time: new Date().toISOString(),
        exam: exam,
        belt: belt,
        status: "SENDING"
    });

    renderHistory();

    try{

        await sendBatch(payload);

        loadSignatureStatus();
        updateHistory(historyId, { status: "SENT" });
        renderHistory();

        const judge = localStorage.getItem("judge");
        const key = `draft_${judge}_${exam}_${belt}`;
        localStorage.removeItem(key);

        loadCandidates();
        alert("ƒê√£ l∆∞u ƒëi·ªÉm & k√Ω x√°c nh·∫≠n th√†nh c√¥ng");

        openTab("print");
        loadPrintPdf();

    } catch (error) {

        console.error("Submit error:", error);

        // üîé N·∫øu th·∫≠t s·ª± m·∫•t m·∫°ng
        if (!navigator.onLine) {

            saveToQueue(payload);

            updateHistory(historyId, { status: "FAILED" });
            renderHistory();

            alert("M·∫•t k·∫øt n·ªëi Internet. ƒê√£ l∆∞u v√†o h√†ng ch·ªù.");
            return;
        }

        // üîé N·∫øu server tr·∫£ l·ªói (400, 500...)
        updateHistory(historyId, { status: "FAILED" });
        renderHistory();

        alert("G·ª≠i th·∫•t b·∫°i:\n" + error.message);
    }
}

async function sendBatch(payload) {

    // =============================
    // 1Ô∏è‚É£ G·ª¨I ƒêI·ªÇM T·ª™NG TH√ç SINH
    // =============================

    for (let item of payload.rows) {

        const res = await fetch(`${API_BASE}/save_score`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                client_txn_id: item.client_txn_id,
                candidate_id: item.candidate_id,
                exam: payload.exam,
                scores: item.scores
            })
        });

        if (!res.ok) {
            const text = await res.text();
            throw new Error("L·ªói l∆∞u ƒëi·ªÉm: " + text);
        }
    }

    // =============================
    // 2Ô∏è‚É£ X√ÅC ƒê·ªäNH ROLE (judge/chief)
    // =============================

    const judgeName = localStorage.getItem("judge");
    let role = "judge";

    try {

        const assignRes = await fetch(
            `${API_BASE}/get_assignment?exam=${encodeURIComponent(payload.exam)}`
        );

        if (assignRes.ok) {

            const assignData = await assignRes.json();

            if (assignData.chief === judgeName) {
                role = "chief";
            }
        }

    } catch (err) {
        console.log("Kh√¥ng ki·ªÉm tra ƒë∆∞·ª£c ph√¢n c√¥ng, m·∫∑c ƒë·ªãnh judge");
    }

    // =============================
    // 3Ô∏è‚É£ G·ª¨I CH·ªÆ K√ù
    // =============================

    const sigRes = await fetch(`${API_BASE}/save_signature`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            exam: payload.exam,
            belt: payload.belt,
            signer_name: payload.signature_name,   // ƒë√∫ng key backend
            role: role,                            // üî• b·∫Øt bu·ªôc
            signature_image: payload.signature_image
        })
    });

    if (!sigRes.ok) {
        const text = await sigRes.text();
        throw new Error("L·ªói l∆∞u ch·ªØ k√Ω: " + text);
    }

    const sigData = await sigRes.json();

    if (sigData.status !== "success" && sigData.status !== "duplicate") {
        throw new Error("L∆∞u ch·ªØ k√Ω th·∫•t b·∫°i: " + JSON.stringify(sigData));
    }

    return true;
}

// M·ªöI
function loadCandidates(silent = false){
  const exam = document.getElementById("examSelect").value;
  const belt = document.getElementById("beltSelect").value;

  if(!examConfirmed){
    if(!silent) alert("VUI L√íNG X√ÅC NH·∫¨N KH√ìA THI");
    return;
  }
  if(!exam || !belt) return;

  if(isOfflineMode()){
    const data = loadOfflineDataFromStorage();
    const list = (data.candidates?.[belt] || []);
    renderCandidateRows(list);
    return;
  }

  fetch(`${API_BASE}/candidates?exam=${encodeURIComponent(exam)}&belt=${encodeURIComponent(belt)}`)
    .then(res => res.json())
    .then(list => {
      // üî• Ki·ªÉm tra xem GK c√≥ ƒëang nh·∫≠p d·ªü kh√¥ng
      const judge = localStorage.getItem("judge");
      const key = `draft_${judge}_${exam}_${belt}`;
      const hasDraft = !!localStorage.getItem(key);

      if(hasDraft && silent){
        // ƒêang c√≥ draft ‚Üí ch·ªâ merge ƒëi·ªÉm t·ª´ server v√†o,
        // KH√îNG ghi ƒë√® √¥ ƒëang nh·∫≠p c·ªßa GK n√†y
        mergeServerScores(list);
      } else {
        renderCandidateRows(list);
      }
    })
    .catch(err => {
      console.error(err);
      if(!silent) alert("Kh√¥ng load ƒë∆∞·ª£c danh s√°ch th√≠ sinh");
    });
}

// M·ªöI
function mergeServerScores(serverList){
  serverList.forEach(c => {
    const row = document.querySelector(`#scoreTable tbody tr[data-id="${c.id}"]`);
    if(!row) return;

    const inputs = row.querySelectorAll("input");
    const totalCell = row.querySelector(".total-cell");
    const rankCell = row.cells[row.cells.length - 2];
    const resultCell = row.cells[row.cells.length - 1];

    (c.scores || []).forEach((val, idx) => {
      if(!inputs[idx]) return;

      const hasServerValue = (val !== null && val !== undefined && val !== "");
      const myValue = inputs[idx].value.trim();

      if(hasServerValue && myValue === ""){
        // üî• Server c√≥ ƒëi·ªÉm, GK n√†y ch∆∞a nh·∫≠p ‚Üí ƒëi·ªÅn + lock
        inputs[idx].value = val;
        inputs[idx].disabled = true;
        inputs[idx].style.background = "#e9ecef";
        inputs[idx].style.color = "#555";
        inputs[idx].style.cursor = "not-allowed";

        const num = parseFloat(val);
        if(!isNaN(num) && num <= 4.5){
          inputs[idx].classList.add("score-low");
        }
      }
      // N·∫øu GK n√†y ƒë√£ nh·∫≠p ‚Üí gi·ªØ nguy√™n, kh√¥ng ƒë·ª•ng v√†o
    });

    // Lu√¥n c·∫≠p nh·∫≠t t·ªïng/h·∫°ng/k·∫øt qu·∫£ t·ª´ server
    if(c.total !== "")  totalCell.innerHTML = `<b>${c.total}</b>`;
    if(c.rank !== "")   rankCell.textContent = c.rank;
    if(c.result !== "") resultCell.textContent = c.result;
  });
}

// M·ªöI
function renderCandidateRows(list){
  const tbody = document.querySelector("#scoreTable tbody");
  tbody.innerHTML = "";

  list.forEach((c, index) => {

    // üî• M·ªói √¥ ƒëi·ªÉm: n·∫øu server ƒë√£ c√≥ gi√° tr·ªã ‚Üí lock, t√¥ x√°m
    const scoreInputs = (c.scores || ["","","","","",""]).map(s => {
      const hasValue = (s !== null && s !== undefined && s !== "");
      const num = parseFloat(s);
      const isLow = hasValue && !isNaN(num) && num <= 4.5;

      const lockedStyle = hasValue
        ? `background:#e9ecef; color:#555; cursor:not-allowed;`
        : "";
      const lowClass = isLow ? `score-low` : "";
      const disabledAttr = hasValue ? `disabled` : "";

      return `<td><input type="text" inputmode="decimal"
        pattern="[0-9]*[.,]?[0-9]*"
        autocomplete="off" autocapitalize="off" spellcheck="false"
        value="${s ?? ''}"
        class="${lowClass}"
        style="${lockedStyle}"
        ${disabledAttr}
      ></td>`;
    }).join("");

    const row = `
      <tr data-id="${c.id}">
        <td>${index + 1}</td>
        <td>${c.name}</td>
        <td>${c.birth_year}</td>
        <td>${c.unit ?? ""}</td>
        ${scoreInputs}
        <td class="total-cell"><b>${c.total ? c.total : ""}</b></td>
        <td>${c.rank ? c.rank : ""}</td>
        <td>${c.result ? c.result : ""}</td>
      </tr>
    `;
    tbody.innerHTML += row;
  });

  restoreDraft();
  attachScoreInputHandlers();
}

function attachScoreInputHandlers(){
  const rows = document.querySelectorAll("#scoreTable tbody tr");

  rows.forEach(row => {
    const inputs = row.querySelectorAll("input");
    const totalCell = row.querySelector(".total-cell");

    inputs.forEach(input => {
        // M·ªöI
        input.addEventListener("input", function(){
            let val = this.value;
            val = val.replace(/[^0-9.,]/g, "");
            val = val.replace(",", ".");
            this.value = val;

            // üî• t√¥ m√†u realtime
            const num = parseFloat(val);
            if(!isNaN(num) && num <= 4.5){
                this.classList.add("score-low");
            } else {
                this.classList.remove("score-low");
            }

            calculateTotal();
            saveDraft();
        });

        input.addEventListener("blur", function(){
            let val = parseFloat(this.value.replace(",", "."));
            if(isNaN(val)){
                this.value = "";
                this.classList.remove("score-low");
                calculateTotal();
                return;
            }
            if(val < 0) val = 0;
            if(val > 10) val = 10;
            this.value = val.toFixed(1);

            // üî• t√¥ m√†u sau blur
            if(val <= 4.5){
                this.classList.add("score-low");
            } else {
                this.classList.remove("score-low");
            }

            calculateTotal();
            saveDraft();
        });
    });

    function calculateTotal(){
      let sum = 0;
      inputs.forEach(i=>{
        let v = parseFloat(i.value);
        if(!isNaN(v)) sum += v;
      });
      totalCell.innerHTML = "<b>" + sum.toFixed(1) + "</b>";
    }
  });
}
// ===================
// EVENT
// ===================
document.getElementById("examSelect")
.addEventListener("change", function(){
    const exam = this.value;

    document.getElementById("welcomeBox").innerHTML =
        "ƒê√£ ch·ªçn kh√≥a thi: <b>" + exam + "</b>";

    loadBelts();
});


document.getElementById("beltSelect")
.addEventListener("change", function(){
    loadExamHeaders();
    loadCandidates();
    loadSignatureStatus();   // üëà th√™m d√≤ng n√†y
});


// ===================
// LOGIN
// ===================
async function login(){
  const judge = document.getElementById("loginJudge").value;
  const pass  = document.getElementById("loginPassword").value;

  if(!judge){
    alert("Ch·ªçn gi√°m kh·∫£o");
    return;
  }

  try{
    const res = await fetch(API_BASE + "/login", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ name: judge, password: pass })
    });

    if(!res.ok){
      throw new Error("HTTP " + res.status);
    }

    const data = await res.json();

    if(data.status !== "success"){
      alert(data.message || "Login fail");
      return;
    }

    if(data.must_change === 1){
      showChangePasswordPopup(judge);
      return;
    }

    // ‚úÖ login online
    localStorage.setItem("judge", judge);
    localStorage.setItem("LOGIN_MODE", "ONLINE");

    document.getElementById("loginPage").style.display="none";
    document.getElementById("dashboard").style.display="block";
    document.getElementById("judgeName").innerText = judge;

    loadExams();
    renderHistory();
    return;

  }catch(err){

    // ‚úÖ login offline fallback
    const data = loadOfflineDataFromStorage();
    if(!data){
      alert("‚ùå Server ƒëang t·∫Øt v√† m√°y n√†y ch∆∞a c√≥ d·ªØ li·ªáu Offline.\nH√£y n·∫°p file JSON export tr∆∞·ªõc.");
      return;
    }

    const ok = confirm("Server ƒëang OFFLINE.\nB·∫°n c√≥ mu·ªën v√†o ch·∫ø ƒë·ªô OFFLINE ƒë·ªÉ ch·∫•m kh√¥ng?");
    if(!ok) return;

    localStorage.setItem("judge", judge);
    localStorage.setItem("LOGIN_MODE", "OFFLINE");

    document.getElementById("loginPage").style.display="none";
    document.getElementById("dashboard").style.display="block";
    document.getElementById("judgeName").innerText = judge + " (OFFLINE)";

    // n·∫°p data offline v√†o UI
    const examSelect = document.getElementById("examSelect");
    examSelect.innerHTML = `<option value="${data.exam}">${data.exam}</option>`;
    examSelect.value = data.exam;

    const beltSelect = document.getElementById("beltSelect");
    beltSelect.innerHTML = "";
    data.belts.forEach(b => beltSelect.innerHTML += `<option value="${b}">${b}</option>`);

    alert("‚úÖ ƒê√£ v√†o ch·∫ø ƒë·ªô OFFLINE.\nH√£y b·∫•m X√ÅC NH·∫¨N kh√≥a thi r·ªìi ch·∫•m.");
    renderHistory();
  }
}

function showChangePasswordPopup(name){

    while(true){

        const newPass = prompt("B·∫°n ƒëang d√πng m·∫≠t kh·∫©u m·∫∑c ƒë·ªãnh.\nNh·∫≠p m·∫≠t kh·∫©u m·ªõi:");

        if(!newPass){
            alert("B·∫Øt bu·ªôc ph·∫£i ƒë·ªïi m·∫≠t kh·∫©u!");
            continue;   // quay l·∫°i nh·∫≠p l·∫°i l·∫ßn 1
        }

        if(newPass.length < 6){
            alert("M·∫≠t kh·∫©u ph·∫£i t·ªëi thi·ªÉu 6 k√Ω t·ª±");
            continue;
        }

        const confirmPass = prompt("Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi:");

        if(newPass !== confirmPass){
            alert("M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng kh·ªõp! Vui l√≤ng nh·∫≠p l·∫°i t·ª´ ƒë·∫ßu.");
            continue;   // quay l·∫°i nh·∫≠p l·∫°i l·∫ßn 1
        }

        // N·∫øu ƒë·∫øn ƒë√¢y nghƒ©a l√† h·ª£p l·ªá
        fetch(API_BASE + "/change_password", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
                name:name,
                new_password:newPass
            })
        })
        .then(()=> {
            alert("ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
            location.reload();
        });

        break; // tho√°t v√≤ng l·∫∑p
    }
}

// ===================
// LOGOUT
// ===================
function logout(){
    localStorage.clear();
    location.reload();
}

// M·ªöI
function openTab(tabName){

    if ((tabName === "score" || tabName === "print") && !examConfirmed) {
        alert("VUI L√íNG X√ÅC NH·∫¨N KH√ìA THI");
        return;
    }

    const tabs = document.querySelectorAll(".tab-content");
    tabs.forEach(tab => {
        tab.classList.remove("tab-active");
    });

    document.getElementById(tabName)
        .classList.add("tab-active");

    if (tabName === "print" && isOfflineMode()) {
        alert("Ch·∫ø ƒë·ªô OFFLINE kh√¥ng th·ªÉ in PDF.\nVui l√≤ng sync khi c√≥ m·∫°ng.");
        return;
    }

    // üî• TH√äM D√íNG N√ÄY: t·ª± ƒë·ªông reload tr·∫°ng th√°i ch·ªØ k√Ω khi v√†o tab score
    if (tabName === "score" && examConfirmed) {
        loadCandidates(true);   // silent reload 
        loadSignatureStatus();
    }
}

async function confirmExam(){

    const exam = document.getElementById("examSelect").value;
    const judge = localStorage.getItem("judge");

    if(!exam){
        alert("Vui l√≤ng ch·ªçn kh√≥a thi");
        return;
    }

    try{
        const res = await fetch(
            `${API_BASE}/get_assignment?exam=${encodeURIComponent(exam)}`
        );

        if(!res.ok){
            alert("Kh√≥a thi ch∆∞a ƒë∆∞·ª£c ph√¢n c√¥ng.");
            return;
        }

        const data = await res.json();

        let role = null;

        if(data.chief === judge){
            role = "Ch√°nh Ch·ªß kh·∫£o";
        }
        else if(data.judges.includes(judge)){
            role = "Gi√°m kh·∫£o";
        }
        else{
            alert("B·∫°n kh√¥ng ƒë∆∞·ª£c ph√¢n c√¥ng cho kh√≥a thi n√†y.");
            return;
        }

        examConfirmed = true;

        document.getElementById("welcomeBox").innerHTML =
            `B·∫°n ƒë∆∞·ª£c ph√¢n c√¥ng l√†m <b>${role}</b> c·ªßa kh√≥a thi: <b>${exam}</b>`;
        loadSignatureStatus();
    }catch(err){
        alert("Kh√¥ng ki·ªÉm tra ƒë∆∞·ª£c ph√¢n c√¥ng.");
    }
}

function resetPassword(){

    const judge = document.getElementById("loginJudge").value;

    if(!judge){
        alert("Vui l√≤ng ch·ªçn gi√°m kh·∫£o");
        return;
    }

    fetch(API_BASE + "/request_reset", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ name: judge })
    })
    .then(res=>res.json())
    .then(data=>{
        if(data.status === "success"){
            alert("Y√™u c·∫ßu reset m·∫≠t kh·∫©u ƒë√£ g·ª≠i t·ªõi Ban t·ªï ch·ª©c.\nVui l√≤ng ch·ªù ph√™ duy·ªát.");
        }
    });
}

function saveDraft(){
    const exam = document.getElementById("examSelect").value;
    const belt = document.getElementById("beltSelect").value;

    if(!exam || !belt) return;

    const rows = document.querySelectorAll("#scoreTable tbody tr");

    const draft = [];

    rows.forEach(row=>{
        const id = row.getAttribute("data-id");
        const inputs = row.querySelectorAll("input");

        const scores = Array.from(inputs).map(i=>i.value);

        draft.push({
            candidate_id: id,
            scores: scores
        });
    });

    const judge = localStorage.getItem("judge");
    const key = `draft_${judge}_${exam}_${belt}`;
    localStorage.setItem(key, JSON.stringify(draft));
}

function restoreDraft(){

    const exam = document.getElementById("examSelect").value;
    const belt = document.getElementById("beltSelect").value;

    const judge = localStorage.getItem("judge");
    const key = `draft_${judge}_${exam}_${belt}`;
    const draft = localStorage.getItem(key);

    if(!draft) return;

    const data = JSON.parse(draft);

    data.forEach(item=>{
        const row = document.querySelector(
            `#scoreTable tbody tr[data-id="${item.candidate_id}"]`
        );

        if(!row) return;

        const inputs = row.querySelectorAll("input");

        // M·ªöI
        item.scores.forEach((val, index)=>{
            if(inputs[index]){
                inputs[index].value = val;

                // üî• t√¥ m√†u khi restore
                const num = parseFloat(val);
                if(!isNaN(num) && num <= 4.5){
                    inputs[index].classList.add("score-low");
                } else {
                    inputs[index].classList.remove("score-low");
                }
            }
        });

        // T√≠nh l·∫°i t·ªïng
        let sum = 0;
        inputs.forEach(i=>{
            let v = parseFloat(i.value);
            if(!isNaN(v)) sum += v;
        });

        row.querySelector(".total-cell").innerHTML =
            "<b>" + sum.toFixed(1) + "</b>";
    });
}

function switchSignatureMode(){
    const mode = document.getElementById("signatureMode").value;

    document.getElementById("drawArea").style.display =
        mode === "draw" ? "block" : "none";

    document.getElementById("uploadArea").style.display =
        mode === "upload" ? "block" : "none";
}

const canvas = document.getElementById("signatureCanvas");
const ctx = canvas.getContext("2d");

let drawing = false;

canvas.addEventListener("mousedown", ()=> drawing = true);
canvas.addEventListener("mouseup", ()=> {
    drawing = false;
    ctx.beginPath();
});
canvas.addEventListener("mousemove", draw);
canvas.addEventListener("touchstart", e => {
    drawing = true;
});

canvas.addEventListener("touchend", e => {
    drawing = false;
    ctx.beginPath();
});

canvas.addEventListener("touchmove", function(e){
    e.preventDefault();
    if(!drawing) return;

    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];

    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#0033CC";   // Blue ƒë·∫≠m

    ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
});


function draw(e){
    if(!drawing) return;

    const rect = canvas.getBoundingClientRect();
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#0033CC";   // Blue ƒë·∫≠m

    ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
}

function clearCanvas(){
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

let uploadedSignature = null;

document.getElementById("signatureUpload")
.addEventListener("change", function(){

    const file = this.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = function(e){
        uploadedSignature = e.target.result;
        document.getElementById("previewBox").innerHTML =
            `<img src="${uploadedSignature}" width="200">`;
    };
    reader.readAsDataURL(file);
});

// ===================
// HISTORY (LOCAL)
// ===================
function getJudge() {
  return localStorage.getItem("judge") || "UNKNOWN";
}

function historyKey() {
  return `SEND_HISTORY::${getJudge()}`;
}

function loadHistory() {
  try {
    return JSON.parse(localStorage.getItem(historyKey()) || "[]");
  } catch {
    return [];
  }
}

function saveHistory(list) {
  localStorage.setItem(historyKey(), JSON.stringify(list));
}

function addHistory(item) {
  const list = loadHistory();
  list.unshift(item); // m·ªõi nh·∫•t l√™n ƒë·∫ßu
  saveHistory(list);
}

function updateHistory(id, patch) {
  const list = loadHistory();
  const idx = list.findIndex(x => x.id === id);
  if (idx >= 0) {
    list[idx] = { ...list[idx], ...patch };
    saveHistory(list);
  }
}

function fmtTime(iso) {
  try {
    return new Date(iso).toLocaleString();
  } catch {
    return iso || "";
  }
}

function statusText(status) {
  if (status === "SENT") return "Th√†nh c√¥ng";
  if (status === "FAILED") return "Kh√¥ng th√†nh c√¥ng";
  if (status === "SENDING") return "ƒêang g·ª≠i";
  return status || "";
}

function statusColor(status) {
  if (status === "SENT") return "green";
  if (status === "FAILED") return "red";
  if (status === "SENDING") return "orange";
  return "";
}

function deleteHistoryItem(id) {
  const list = loadHistory();
  const item = list.find(x => x.id === id);

  const label = item ? `${item.exam || ""} - ${item.belt || ""}`.trim() : "";
  if (!confirm(`X√≥a l·ªãch s·ª≠ l·∫ßn g·ª≠i n√†y?\n${label}`)) return;

  const next = list.filter(x => x.id !== id);
  saveHistory(next);
  renderHistory();
}

function renderHistory() {
  const tbody = document.getElementById("historyBody");
  const statusEl = document.getElementById("historyStatus");
  if (!tbody) return;

  const list = loadHistory();
  tbody.innerHTML = "";

  if (list.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; opacity:.7;">Ch∆∞a c√≥ l·ªãch s·ª≠</td></tr>`;
    if (statusEl) statusEl.textContent = "";
    return;
  }

  for (const it of list) {
    const tr = document.createElement("tr");

    const td1 = document.createElement("td");
    td1.textContent = fmtTime(it.time);

    const td2 = document.createElement("td");
    td2.textContent = `${it.exam || ""} - ${it.belt || ""}`.trim();

    const td3 = document.createElement("td");
    td3.textContent = statusText(it.status);
    const c = statusColor(it.status);
    if (c) td3.style.color = c;
    td3.style.fontWeight = "bold";

    const td4 = document.createElement("td");
    const delBtn = document.createElement("button");
    delBtn.className = "btn-danger";
    delBtn.textContent = "X√≥a";
    delBtn.onclick = () => deleteHistoryItem(it.id);
    td4.appendChild(delBtn);

    tr.appendChild(td1);
    tr.appendChild(td2);
    tr.appendChild(td3);
    tr.appendChild(td4);

    tbody.appendChild(tr);
  }

  if (statusEl) statusEl.textContent = `T·ªïng: ${list.length} l·∫ßn`;
}

function clearHistory() {
  if (!confirm("X√≥a to√†n b·ªô l·ªãch s·ª≠ tr√™n m√°y n√†y?")) return;
  saveHistory([]);
  renderHistory();
}

function loadPrintPdf() {
  const exam = document.getElementById("examSelect").value;
  const belt = document.getElementById("beltSelect").value;
  if (!exam || !belt) {
    alert("Ch·ªçn kh√≥a thi v√† c·∫•p ƒëai tr∆∞·ªõc");
    return;
  }

  const organizer = ""; // n·∫øu mu·ªën truy·ªÅn ƒë∆°n v·ªã t·ªï ch·ª©c th√¨ g√°n v√†o ƒë√¢y

  const url =
    `${API_BASE}/print_score_pdf?exam=${encodeURIComponent(exam)}&belt=${encodeURIComponent(belt)}&organizer=${encodeURIComponent(organizer)}&t=${Date.now()}`;

  document.getElementById("pdfFrame").src = url;

  const link = document.getElementById("pdfOpenLink");
  link.href = url;
  link.textContent = "M·ªü PDF ·ªü tab m·ªõi";

  document.getElementById("printHint").textContent = `${exam} - ${belt}`;
}

// ===============================
// AUTO RETRY
// ===============================

setInterval(() => {

    if (isOfflineMode()) return;
    if (!offlineDB) return;

    getAllQueue(async (items) => {

        for (let item of items) {

            try {
                await sendBatch(item.data);

                removeFromQueue(item.id);

                // üî• c·∫≠p nh·∫≠t l·∫°i History
                updateHistory(item.id, { status: "SENT" });
                renderHistory();

                console.log("ƒê√£ g·ª≠i l·∫°i th√†nh c√¥ng batch:", item.id);

            } catch (err) {
                console.log("V·∫´n ch∆∞a g·ª≠i ƒë∆∞·ª£c:", item.id);
            }

        }

    });

}, 20000);

function isOfflineMode(){
  return (localStorage.getItem("LOGIN_MODE") === "OFFLINE");
}


</script>


</body>
</html>

